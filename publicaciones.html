<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Publicaciones · Herramientas FECCOOEx</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:#f3f4f6;
      color:#222;
    }

    /* HEADER */
    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:14px 24px;
      background:#d60000;
      color:#fff;
      box-shadow:0 2px 6px rgba(0,0,0,0.25);
      position:sticky;
      top:0;
      z-index:10;
    }
    header img{ height:52px; }
    .titles h1{ margin:0; font-size:1.6rem; font-weight:700; }
    .titles p{ margin:2px 0 0; font-size:0.9rem; opacity:0.95; }
    nav a{
      color:#fff;
      text-decoration:none;
      font-weight:600;
      padding:6px 12px;
      border:1px solid rgba(255,255,255,0.7);
      border-radius:999px;
    }

    /* MAIN */
    main{
      max-width:1180px;
      margin:26px auto 40px;
      padding:0 16px 40px;
    }

    .btn-volver{
      display:inline-block;
      margin-bottom:16px;
      padding:6px 10px;
      border-radius:6px;
      background:#d60000;
      color:#fff;
      font-size:0.9rem;
      font-weight:600;
      text-decoration:none;
    }

    .page-title{ margin:0 0 6px; font-size:1.6rem; }
    .page-subtitle{ margin:0 0 14px; color:#444; font-size:0.95rem; }

    .card{
      background:#fff;
      border:1px solid #e1e4ea;
      border-radius:12px;
      box-shadow:0 3px 10px rgba(0,0,0,0.10);
      padding:14px 16px 16px;
      margin-bottom:14px;
    }

    /* FILTROS */
    .filters{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:10px;
      align-items:end;
    }
    @media (max-width: 980px){
      .filters{ grid-template-columns: 1fr; }
    }

    label{
      font-size:0.82rem;
      font-weight:800;
      color:#555;
      display:block;
      margin-bottom:4px;
    }

    select, input{
      width:100%;
      font-family:inherit;
      font-size:0.95rem;
      padding:8px 10px;
      border-radius:8px;
      border:1px solid #cbd5e1;
      background:#fff;
    }

    .actions-filters{
      display:flex;
      gap:12px;
      margin-top:12px;
      flex-wrap:wrap;
      align-items:center;
    }

    .btn{
      border:none;
      border-radius:8px;
      padding:8px 12px;
      font-weight:800;
      cursor:pointer;
      background:#d60000;
      color:#fff;
    }
    .btn.secondary{
      background:#444;
    }

    .status{
      font-size:0.85rem;
      color:#555;
      margin-top:6px;
    }

    /* GRID */
    .grid{
      margin-top:12px;
      display:grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap:12px;
    }
    @media (max-width: 1080px){
      .grid{ grid-template-columns: repeat(2, minmax(0,1fr)); }
    }
    @media (max-width: 700px){
      .grid{ grid-template-columns: 1fr; }
    }

    .pub{
      background:#fff;
      border:1px solid #e1e4ea;
      border-radius:14px;
      box-shadow:0 3px 10px rgba(0,0,0,0.10);
      padding:14px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }

    .badge{
      font-size:0.75rem;
      font-weight:900;
      padding:3px 10px;
      border-radius:999px;
      background:#f3f4f6;
      border:1px solid #e5e7eb;
      display:inline-block;
    }

    .title{
      margin:0;
      font-size:1.05rem;
      font-weight:900;
    }

    .meta{
      font-size:0.82rem;
      color:#555;
      display:flex;
      flex-direction:column;
      gap:3px;
    }

    .desc{
      font-size:0.92rem;
      color:#374151;
      flex:1;
    }

    .btn-primary{
      align-self:flex-start;
      background:#d60000;
      color:#fff;
      text-decoration:none;
      padding:8px 12px;
      border-radius:8px;
      font-weight:900;
    }
  </style>
</head>

<body>

<header>
  <div style="display:flex; gap:16px; align-items:center;">
    <img src="img/feccooex.png" alt="FECCOOEx">
    <div class="titles">
      <h1>Herramientas FECCOOEx</h1>
      <p>Recursos públicos y sindicales para la comunidad educativa</p>
    </div>
  </div>
  <nav>
    <a href="delegados.html">Área delegados/as</a>
  </nav>
</header>

<main>
  <a class="btn-volver" href="index.html">Volver a la portada</a>

  <h1 class="page-title">Publicaciones sindicales</h1>
  <p class="page-subtitle">
    Filtra por temática, tipo, ámbito o año para consultar las publicaciones disponibles.
  </p>

  <!-- FILTROS -->
  <section class="card">
    <div class="filters">
      <div>
        <label>Temática</label>
        <select id="f-tema"></select>
      </div>
      <div>
        <label>Tipo</label>
        <select id="f-tipo"></select>
      </div>
      <div>
        <label>Ámbito</label>
        <select id="f-ambito"></select>
      </div>
      <div>
        <label>Año</label>
        <select id="f-anio"></select>
      </div>
    </div>

    <div style="margin-top:10px;">
      <label>Buscar texto</label>
      <input id="f-texto" placeholder="Título, resumen, palabras clave…" />
    </div>

    <div class="actions-filters">
      <button class="btn secondary" id="btn-limpiar">Limpiar filtros</button>
    </div>
  </section>

  <!-- RESULTADOS -->
  <section class="card">
    <div id="status" class="status">
      Selecciona algún filtro para mostrar publicaciones.
    </div>
    <div id="grid" class="grid"></div>
  </section>
</main>

<script>
const CSV_PATH = "publicaciones.csv";

const fTema  = document.getElementById("f-tema");
const fTipo  = document.getElementById("f-tipo");
const fAmb   = document.getElementById("f-ambito");
const fAnio  = document.getElementById("f-anio");
const fTexto = document.getElementById("f-texto");
const btnLimpiar = document.getElementById("btn-limpiar");

const grid = document.getElementById("grid");
const statusEl = document.getElementById("status");

let publicaciones = [];

function parseCSV(text){
  const rows = [];
  let row=[], val="", inQ=false;
  const first = text.split(/\r?\n/).find(l=>l.trim());
  const d = first && first.includes(";") ? ";" : ",";
  for(let i=0;i<text.length;i++){
    const c=text[i], n=text[i+1];
    if(c=='"'&&inQ&&n=='"'){ val+='"'; i++; }
    else if(c=='"'){ inQ=!inQ; }
    else if(c==d&&!inQ){ row.push(val); val=""; }
    else if((c=="\n"||c=="\r")&&!inQ){
      if(val||row.length){ row.push(val); rows.push(row); row=[]; val=""; }
    } else val+=c;
  }
  if(val||row.length){ row.push(val); rows.push(row); }
  return rows.map(r=>r.map(x=>(x||"").trim()));
}

function unique(arr){
  return Array.from(new Set(arr.filter(Boolean))).sort((a,b)=>a.localeCompare(b,"es"));
}
function year(fecha){
  const m=(fecha||"").match(/^(\d{4})/); return m?m[1]:"";
}

function filtrosActivos(){
  return fTema.value || fTipo.value || fAmb.value || fAnio.value || fTexto.value.trim();
}

function applyFilters(){
  grid.innerHTML="";
  if(!filtrosActivos()){
    statusEl.textContent="Selecciona algún filtro para mostrar publicaciones.";
    return;
  }

  const res = publicaciones.filter(p=>{
    if(p.activo==="0") return false;
    if(fTema.value && p.tema!==fTema.value) return false;
    if(fTipo.value && p.tipo!==fTipo.value) return false;
    if(fAmb.value && p.ambito!==fAmb.value) return false;
    if(fAnio.value && year(p.fecha)!==fAnio.value) return false;
    if(fTexto.value){
      const blob=Object.values(p).join(" ").toLowerCase();
      if(!blob.includes(fTexto.value.toLowerCase())) return false;
    }
    return true;
  });

  statusEl.textContent = res.length
    ? `Mostrando ${res.length} publicación(es).`
    : "No hay resultados con los filtros seleccionados.";

  res.forEach(p=>{
    const el=document.createElement("article");
    el.className="pub";
    el.innerHTML=`
      <span class="badge">${p.tema||"Sin temática"}</span>
      <h3 class="title">${p.titulo||"Publicación"}</h3>
      <div class="meta">
        <div><strong>Fecha:</strong> ${p.fecha||"-"}</div>
        <div><strong>Ámbito:</strong> ${p.ambito||"-"}</div>
        <div><strong>Tipo:</strong> ${p.tipo||"-"}</div>
      </div>
      <p class="desc">${p.resumen||""}</p>
      ${p.url ? `<a class="btn-primary" href="${p.url}" target="_blank">Abrir publicación</a>` : ""}
    `;
    grid.appendChild(el);
  });
}

async function init(){
  const r=await fetch(CSV_PATH,{cache:"no-store"});
  const t=await r.text();
  const rows=parseCSV(t);
  const h=rows[0];
  publicaciones=rows.slice(1).map(r=>{
    const o={}; h.forEach((k,i)=>o[k]=r[i]||""); return o;
  });

  fTema.innerHTML = '<option value="">Selecciona temática…</option>';
  unique(publicaciones.map(p=>p.tema)).forEach(v=>fTema.add(new Option(v,v)));

  fTipo.innerHTML = '<option value="">Selecciona tipo…</option>';
  unique(publicaciones.map(p=>p.tipo)).forEach(v=>fTipo.add(new Option(v,v)));

  fAmb.innerHTML = '<option value="">Selecciona ámbito…</option>';
  unique(publicaciones.map(p=>p.ambito)).forEach(v=>fAmb.add(new Option(v,v)));

  fAnio.innerHTML = '<option value="">Selecciona año…</option>';
  unique(publicaciones.map(p=>year(p.fecha))).sort((a,b)=>b-a)
    .forEach(v=>fAnio.add(new Option(v,v)));

  [fTema,fTipo,fAmb,fAnio].forEach(s=>s.addEventListener("change",applyFilters));
  fTexto.addEventListener("input",applyFilters);

  btnLimpiar.addEventListener("click",()=>{
    [fTema,fTipo,fAmb,fAnio,fTexto].forEach(x=>x.value="");
    grid.innerHTML="";
    statusEl.textContent="Selecciona algún filtro para mostrar publicaciones.";
  });
}

init();
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Calendarios · Herramientas FECCOOEx</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- FOOTER CENTRALIZADO -->
  <link rel="stylesheet" href="/assets/footer.css" />

  <style>
    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f3f4f6;
      color: #222;
    }

    /* HEADER */
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 24px;
      background: #d60000;
      color: #fff;
      box-shadow: 0 2px 6px rgba(0,0,0,0.25);
      position: sticky;
      top: 0;
      z-index: 10;
      gap: 16px;
    }

    header img { height: 52px; }

    .titles h1 {
      margin: 0;
      font-size: 1.6rem;
      font-weight: 700;
    }

    .titles p {
      margin: 2px 0 0;
      font-size: 0.9rem;
      opacity: 0.95;
    }

    nav a {
      color: white;
      text-decoration: none;
      font-weight: 600;
      padding: 6px 12px;
      border: 1px solid rgba(255,255,255,0.7);
      border-radius: 999px;
      transition: 0.2s ease;
      white-space: nowrap;
    }

    nav a:hover {
      background: rgba(255,255,255,0.18);
      transform: translateY(-1px);
      box-shadow: 0 2px 6px rgba(0,0,0,0.25);
    }

    /* VOLVER (unificado) */
    .back-wrap{
      max-width:1100px;
      margin:14px auto 0;
      padding:0 16px;
    }
    .back-home{
      display:inline-block;
      background:#d60000;
      color:#fff;
      text-decoration:none;
      font-weight:800;
      padding:8px 12px;
      border-radius:999px;
      box-shadow:0 2px 5px rgba(214,0,0,0.25);
      transition: background 0.15s, transform 0.12s ease, box-shadow 0.12s ease;
      border:1px solid rgba(255,255,255,0.35);
      font-size:.9rem;
    }
    .back-home:hover{
      background:#b40000;
      transform:translateY(-1px);
      box-shadow:0 4px 9px rgba(180,0,0,0.30);
    }

    /* ===== CARRUSEL (universal) ===== */
    .campaign-wrap{
      max-width:1100px;
      margin:12px auto 0;
      padding:0 16px;
    }

    .carousel{
      background:#fff;
      border:1px solid #e1e4ea;
      border-radius:12px;
      box-shadow:0 3px 8px rgba(0,0,0,0.08);
      overflow:hidden;
      position:relative;
    }

    .carousel-track{
      display:flex;
      transition:transform 350ms ease;
      will-change: transform;
    }

    .slide{
      min-width:100%;
      position:relative;
      background:#fff;
    }

    .slide a{
      display:block;
      text-decoration:none;
      color:inherit;
    }

    .slide img{
      display:block;
      width:100%;
      height:auto;
      object-fit:contain;
      max-height:260px;
      background:#fff;
    }

    @media (max-width:700px){
      .slide img{ max-height:180px; }
    }

    .carousel-btn{
      position:absolute;
      top:50%;
      transform:translateY(-50%);
      border:none;
      background:rgba(0,0,0,0.35);
      color:#fff;
      width:40px;
      height:40px;
      border-radius:999px;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      transition:background 120ms ease, transform 120ms ease;
      z-index:2;
    }
    .carousel-btn:hover{
      background:rgba(0,0,0,0.5);
      transform:translateY(-50%) scale(1.03);
    }
    .carousel-btn.prev{ left:10px; }
    .carousel-btn.next{ right:10px; }

    @media (max-width:700px){
      .carousel-btn{ width:36px; height:36px; }
      .carousel-btn.prev{ left:8px; }
      .carousel-btn.next{ right:8px; }
    }

    .dots{
      position:absolute;
      left:0;
      right:0;
      bottom:10px;
      display:flex;
      justify-content:center;
      gap:8px;
      z-index:2;
      padding:0 10px;
    }
    .dot{
      width:10px;
      height:10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.9);
      background:rgba(0,0,0,0.35);
      cursor:pointer;
      transition:transform 120ms ease, background 120ms ease;
    }
    .dot.active{
      background:#d60000;
      border-color:rgba(255,255,255,0.95);
      transform:scale(1.12);
    }

    .carousel-empty{
      padding:14px 16px;
      color:#555;
      font-size:0.95rem;
    }

    /* MAIN */
    main {
      max-width: 1100px;
      margin: 14px auto 40px;
      padding: 0 16px 40px;
    }

    .page-title {
      margin: 0 0 4px;
      font-size: 1.6rem;
    }

    .page-subtitle {
      margin: 0 0 14px;
      font-size: 0.95rem;
      color: #444;
    }

    /* TABS */
    .tabs {
      display: inline-flex;
      border-radius: 999px;
      background: #e5e7eb;
      padding: 3px;
      margin: 0 0 16px;
    }

    .tab-btn {
      border: none;
      background: transparent;
      padding: 6px 14px;
      border-radius: 999px;
      font-size: 0.9rem;
      cursor: pointer;
      font-weight: 600;
      color: #555;
      transition: background 0.15s, color 0.15s, box-shadow 0.15s;
    }

    .tab-btn.active {
      background: #ffffff;
      color: #d60000;
      box-shadow: 0 2px 5px rgba(0,0,0,0.15);
    }

    .tab-content { display: none; }
    .tab-content.active { display: block; }

    /* BLOQUES */
    .block-cal {
      background: #fff;
      border-radius: 10px;
      padding: 14px 16px 18px;
      border: 1px solid #e1e4ea;
      box-shadow: 0 3px 8px rgba(0,0,0,0.10);
    }

    .block-cal h2 {
      margin: 0 0 6px;
      font-size: 1.2rem;
      color: #d60000;
    }

    .block-cal p.intro {
      margin: 0 0 10px;
      font-size: 0.9rem;
      color: #444;
    }

    /* Controles */
    .controles-calendario {
      display: flex;
      flex-wrap: wrap;
      gap: 10px 16px;
      align-items: flex-end;
      margin-bottom: 10px;
      border-radius: 8px;
      background: #f9fafb;
      padding: 10px 10px 8px;
      border: 1px dashed #e5e7eb;
    }

    .control {
      display: flex;
      flex-direction: column;
      gap: 3px;
      min-width: 220px;
    }

    .control label {
      font-size: 0.8rem;
      font-weight: 600;
      color: #555;
    }

    select {
      font-family: inherit;
      font-size: 0.9rem;
      padding: 6px 8px;
      border-radius: 6px;
      border: 1px solid #cbd5e1;
      background: #fff;
    }

    .check-inline {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.82rem;
      color: #444;
      margin-top: 2px;
      padding-bottom: 2px;
    }

    .check-inline input { margin: 0; }

    /* Botón limpiar municipio */
    .btn-limpiar {
      margin-top: 4px;
      align-self: flex-start;
      background: transparent;
      border: none;
      color: #d60000;
      font-size: 0.75rem;
      font-weight: 600;
      cursor: pointer;
      padding: 0;
    }
    .btn-limpiar:hover { text-decoration: underline; }

    /* Listados */
    .nota {
      font-size: 0.85rem;
      color: #555;
      background: #f3f4ff;
      border-radius: 6px;
      padding: 6px 8px;
      border: 1px solid #e5e7eb;
    }

    .cal-lista-wrapper { margin-top: 10px; }

    .cal-mes {
      margin-bottom: 10px;
      padding-bottom: 4px;
      border-bottom: 1px dashed #e5e7eb;
    }
    .cal-mes:last-child { border-bottom: none; }

    .cal-mes h3 {
      margin: 0 0 4px;
      font-size: 1rem;
      color: #111827;
      text-transform: capitalize;
    }

    .cal-lista {
      list-style: none;
      margin: 0;
      padding-left: 0;
      font-size: 0.86rem;
    }

    .cal-lista li { margin: 1px 0; }

    .cal-lista li span.fecha { font-weight: 700; }
    .cal-lista li span.tipo { font-style: italic; color: #6b7280; }
    .cal-lista li span.etapas { color: #4b5563; }

    /* Festivos locales */
    .cal-festivos-locales {
      margin-top: 12px;
      padding-top: 8px;
      border-top: 1px solid #e5e7eb;
    }

    .cal-festivos-locales h3 {
      margin: 0 0 4px;
      font-size: 0.98rem;
      color: #111827;
    }

    .cal-festivos-locales ul {
      margin: 0;
      padding-left: 18px;
      font-size: 0.86rem;
    }
  </style>
</head>

<body>

  <!-- HEADER -->
  <header>
    <div style="display:flex; align-items:center; gap:16px;">
      <img src="/img/feccooex.png" alt="FECCOOEx">
      <div class="titles">
        <h1>Herramientas FECCOOEx</h1>
        <p>Recursos públicos y sindicales para la comunidad educativa</p>
      </div>
    </div>

    <nav>
      <a href="/delegados.html">Área delegados/as</a>
    </nav>
  </header>

  <!-- Volver -->
  <div class="back-wrap">
    <a class="back-home" href="/index.html">Volver a la portada</a>
  </div>

  <!-- Carrusel -->
  <div class="campaign-wrap">
    <div class="carousel" id="campaignCarousel" aria-label="Campañas">
      <div class="carousel-empty" id="carouselEmpty">Cargando campañas…</div>
      <button class="carousel-btn prev" id="carouselPrev" aria-label="Anterior" style="display:none;">‹</button>
      <button class="carousel-btn next" id="carouselNext" aria-label="Siguiente" style="display:none;">›</button>
      <div class="carousel-track" id="carouselTrack" style="display:none;"></div>
      <div class="dots" id="carouselDots" style="display:none;"></div>
    </div>
  </div>

  <!-- CONTENIDO PRINCIPAL -->
  <main>
    <h1 class="page-title">Calendarios de Extremadura</h1>
    <p class="page-subtitle">
      Consulta el calendario escolar y el calendario laboral de Extremadura. Si lo deseas, selecciona un municipio
      para ver sus dos festivos locales.
    </p>

    <!-- PESTAÑAS -->
    <div class="tabs">
      <button class="tab-btn active" data-tab="escolar">Calendario escolar</button>
      <button class="tab-btn" data-tab="laboral">Calendario laboral</button>
    </div>

    <!-- TAB ESCOLAR -->
    <section id="tab-escolar" class="tab-content active">
      <section class="block-cal">
        <h2>Calendario escolar de Extremadura</h2>
        <p class="intro">
          Selecciona el curso académico. Opcionalmente, selecciona un municipio para ver los festivos locales.
        </p>

        <div class="controles-calendario">
          <div class="control">
            <label for="select-curso">Curso académico</label>
            <select id="select-curso">
              <option value="">Selecciona curso…</option>
            </select>
          </div>

          <div class="control">
            <label for="select-municipio-escolar">Municipio (festivos locales)</label>
            <select id="select-municipio-escolar"></select>
            <button type="button" class="btn-limpiar" id="btn-limpiar-escolar">Limpiar municipio</button>
          </div>

          <div class="check-inline">
            <input type="checkbox" id="chk-celebraciones" checked>
            <label for="chk-celebraciones">Mostrar celebraciones pedagógicas</label>
          </div>
        </div>

        <div id="escolar-lista" class="cal-lista-wrapper">
          <p class="nota">Cargando datos del calendario escolar…</p>
        </div>

        <div id="escolar-festivos-locales" class="cal-festivos-locales"></div>
      </section>
    </section>

    <!-- TAB LABORAL -->
    <section id="tab-laboral" class="tab-content">
      <section class="block-cal">
        <h2>Calendario laboral de Extremadura</h2>
        <p class="intro">
          Selecciona el año. Opcionalmente, selecciona un municipio para ver los festivos locales.
        </p>

        <div class="controles-calendario">
          <div class="control">
            <label for="select-anio">Año</label>
            <select id="select-anio">
              <option value="">Selecciona año…</option>
            </select>
          </div>

          <div class="control">
            <label for="select-municipio-laboral">Municipio (festivos locales)</label>
            <select id="select-municipio-laboral"></select>
            <button type="button" class="btn-limpiar" id="btn-limpiar-laboral">Limpiar municipio</button>
          </div>
        </div>

        <div id="laboral-lista" class="cal-lista-wrapper">
          <p class="nota">Cargando datos del calendario laboral…</p>
        </div>

        <div id="laboral-festivos-locales" class="cal-festivos-locales"></div>
      </section>
    </section>
  </main>

  <!-- FOOTER CENTRAL -->
  <div id="site-footer"></div>
  <script src="/assets/footer.js?v=1"></script>

  <script>
    /***********************
     * 1) CARRUSEL UNIVERSAL
     ***********************/
    (function initCarousel(){
      const BANNERS_CSV = "/banners.csv";

      const elEmpty = document.getElementById("carouselEmpty");
      const elTrack = document.getElementById("carouselTrack");
      const elDots  = document.getElementById("carouselDots");
      const btnPrev = document.getElementById("carouselPrev");
      const btnNext = document.getElementById("carouselNext");
      const elCarousel = document.getElementById("campaignCarousel");

      if (!elEmpty || !elTrack || !elDots || !btnPrev || !btnNext || !elCarousel) return;

      let slides = [];
      let index = 0;
      let timer = null;
      const AUTO_MS = 5500;

      function splitCSVLine(line){
        const out = [];
        let cur = "";
        let inQ = false;
        for (let i=0; i<line.length; i++){
          const ch = line[i];
          if (ch === '"' && inQ && line[i+1] === '"'){ cur += '"'; i++; continue; }
          if (ch === '"'){ inQ = !inQ; continue; }
          if (ch === "," && !inQ){ out.push(cur); cur=""; continue; }
          cur += ch;
        }
        out.push(cur);
        return out;
      }
      function parseCSV(text){
        const lines = text.replace(/\r/g, "").split("\n").filter(l => l.trim() !== "");
        if (!lines.length) return [];
        const headers = splitCSVLine(lines[0]).map(h => h.trim());
        return lines.slice(1).map(line => {
          const cols = splitCSVLine(line);
          const obj = {};
          headers.forEach((h,i) => obj[h] = (cols[i] ?? "").trim());
          return obj;
        });
      }
      function normBool(v){
        return ["1","true","si","sí","x","ok"].includes((v||"").toLowerCase().trim());
      }

      function apply(){
        elTrack.style.transform = `translateX(${-index * 100}%)`;
        [...elDots.children].forEach((d, i) => d.classList.toggle("active", i === index));
      }
      function goTo(i, userAction=false){
        index = (i + slides.length) % slides.length;
        apply();
        if (userAction) restartAuto();
      }
      function next(user=false){ goTo(index + 1, user); }
      function prev(user=false){ goTo(index - 1, user); }

      function startAuto(){
        stopAuto();
        timer = setInterval(() => next(false), AUTO_MS);
      }
      function stopAuto(){
        if (timer) { clearInterval(timer); timer = null; }
      }
      function restartAuto(){
        stopAuto();
        startAuto();
      }

      function buildCarousel(items){
        slides = items;
        elTrack.innerHTML = "";
        elDots.innerHTML = "";

        slides.forEach((s, i) => {
          const slide = document.createElement("div");
          slide.className = "slide";

          const imgSrc = s.imagen;
          const alt = s.alt || "Campaña FECCOOEx";
          const href = (s.enlace || "").trim();

          const img = `<img src="${imgSrc}" alt="${alt}" loading="lazy">`;
          slide.innerHTML = href ? `<a href="${href}" aria-label="${alt}">${img}</a>` : img;

          elTrack.appendChild(slide);

          const dot = document.createElement("button");
          dot.className = "dot" + (i === 0 ? " active" : "");
          dot.setAttribute("aria-label", "Ir a campaña " + (i+1));
          dot.addEventListener("click", () => goTo(i, true));
          elDots.appendChild(dot);
        });

        const multi = slides.length > 1;
        elEmpty.style.display = "none";
        elTrack.style.display = "flex";
        elDots.style.display = multi ? "flex" : "none";
        btnPrev.style.display = multi ? "flex" : "none";
        btnNext.style.display = multi ? "flex" : "none";

        index = 0;
        apply();
        if (multi) startAuto();
      }

      elCarousel.addEventListener("mouseenter", stopAuto);
      elCarousel.addEventListener("mouseleave", () => { if (slides.length > 1) startAuto(); });

      btnNext.addEventListener("click", () => next(true));
      btnPrev.addEventListener("click", () => prev(true));

      let touchX = null;
      elCarousel.addEventListener("touchstart", (e) => {
        if (!e.touches || e.touches.length !== 1) return;
        touchX = e.touches[0].clientX;
        stopAuto();
      }, {passive:true});

      elCarousel.addEventListener("touchend", (e) => {
        if (touchX === null) return;
        const endX = (e.changedTouches && e.changedTouches[0]) ? e.changedTouches[0].clientX : touchX;
        const dx = endX - touchX;
        touchX = null;

        if (Math.abs(dx) > 40){
          dx < 0 ? next(true) : prev(true);
        } else {
          restartAuto();
        }
      }, {passive:true});

      fetch(BANNERS_CSV + "?v=" + Date.now())
        .then(r => { if (!r.ok) throw new Error("No se pudo cargar banners.csv"); return r.text(); })
        .then(text => {
          const rows = parseCSV(text);
          const items = rows
            .filter(r => normBool(r.activo))
            .sort((a,b) => (parseInt(a.orden||"999",10) - parseInt(b.orden||"999",10)));

          if (!items.length){
            elEmpty.textContent = "No hay campañas activas.";
            return;
          }
          buildCarousel(items);
        })
        .catch(err => {
          console.error(err);
          elEmpty.textContent = "No se ha podido cargar el banner de campañas.";
        });
    })();

    /***********************
     * 2) CALENDARIOS (tu lógica original)
     ***********************/
    let escolarData = [];
    let laboralData = [];
    let festivosLocales = [];

    const monthNames = [
      "enero","febrero","marzo","abril","mayo","junio",
      "julio","agosto","septiembre","octubre","noviembre","diciembre"
    ];

    function parseCSVSimple(text) {
      const lines = (text || "").trim().split(/\r?\n/);
      if (!lines.length) return [];
      const firstLine = lines[0];
      const delimiter = firstLine.includes(";") ? ";" : ",";
      const headers = firstLine.split(delimiter).map(h => h.trim());
      return lines.slice(1)
        .filter(l => l.trim())
        .map(line => {
          const cols = line.split(delimiter).map(c => c.trim());
          const obj = {};
          headers.forEach((h, i) => { obj[h] = cols[i] || ""; });
          return obj;
        });
    }

    function parseFechaES(texto, anio) {
      const raw = (texto || "").trim().toLowerCase();

      if (/^\d{4}-\d{2}-\d{2}$/.test(raw)) {
        const d = new Date(raw);
        return { date: isNaN(d) ? null : d, display: texto.trim() };
      }

      const norm = raw.replace(/\s+de\s+/g, " ").replace(/\s+/g, " ").trim();
      const m = norm.match(/^(\d{1,2})\s+([a-záéíóúñ]+)$/i);
      if (!m) return { date: null, display: texto.trim() };

      const dia = parseInt(m[1], 10);
      const mesTxt = m[2];

      const meses = {
        "enero": 0, "febrero": 1, "marzo": 2, "abril": 3, "mayo": 4, "junio": 5,
        "julio": 6, "agosto": 7, "septiembre": 8, "setiembre": 8,
        "octubre": 9, "noviembre": 10, "diciembre": 11
      };

      const mes = meses[mesTxt];
      if (mes === undefined) return { date: null, display: texto.trim() };

      const d = new Date(Number(anio), mes, dia);
      return { date: isNaN(d) ? null : d, display: texto.trim() };
    }

    function getAniosCurso(curso) {
      const c = (curso || "").trim();
      const m = c.match(/^(\d{4})\s*-\s*(\d{4})$/);
      if (!m) return null;
      return { anio1: Number(m[1]), anio2: Number(m[2]) };
    }

    function agruparPorMes(eventos, campoFecha, ctx = {}) {
      const porMes = {};
      const anioLaboral = ctx.anio ? Number(ctx.anio) : null;
      const aniosCurso = ctx.curso ? getAniosCurso(ctx.curso) : null;

      eventos.forEach(ev => {
        const fechaTxt = (ev[campoFecha] || "").trim();
        let parsed = { date: null, display: fechaTxt };

        if (ctx.tipo === "laboral" && anioLaboral) {
          parsed = parseFechaES(fechaTxt, anioLaboral);
        } else if (ctx.tipo === "escolar" && aniosCurso) {
          const p1 = parseFechaES(fechaTxt, aniosCurso.anio1);
          if (p1.date) {
            const mes = p1.date.getMonth();
            const anioDef = (mes >= 8) ? aniosCurso.anio1 : aniosCurso.anio2;
            parsed = parseFechaES(fechaTxt, anioDef);
          } else {
            parsed = p1;
          }
        } else {
          const d = new Date(fechaTxt);
          parsed = { date: isNaN(d) ? null : d, display: fechaTxt };
        }

        if (!parsed.date) return;

        const m = parsed.date.getMonth();
        if (!porMes[m]) porMes[m] = [];
        porMes[m].push({ ...ev, _date: parsed.date, _fechaStr: parsed.display });
      });

      Object.keys(porMes).forEach(m => porMes[m].sort((a, b) => a._date - b._date));
      return porMes;
    }

    function renderListaPorMes(container, porMes, opciones = {}) {
      container.innerHTML = "";

      const mesesDisponibles = Object.keys(porMes)
        .map(n => parseInt(n, 10))
        .filter(n => !isNaN(n));

      let mesesOrdenados;
      if (opciones.ordenMeses && Array.isArray(opciones.ordenMeses)) {
        mesesOrdenados = opciones.ordenMeses.filter(m => mesesDisponibles.includes(m));
      } else {
        mesesOrdenados = mesesDisponibles.sort((a, b) => a - b);
      }

      if (!mesesOrdenados.length) {
        container.innerHTML = '<p class="nota">No hay eventos para los filtros seleccionados.</p>';
        return;
      }

      const frag = document.createDocumentFragment();

      mesesOrdenados.forEach(m => {
        const section = document.createElement("section");
        section.className = "cal-mes";

        const h3 = document.createElement("h3");
        h3.textContent = monthNames[m];
        section.appendChild(h3);

        const ul = document.createElement("ul");
        ul.className = "cal-lista";

        porMes[m].forEach(ev => {
          const li = document.createElement("li");

          const spanFecha = document.createElement("span");
          spanFecha.className = "fecha";
          spanFecha.textContent = ev._fechaStr || "";
          li.appendChild(spanFecha);

          li.appendChild(document.createTextNode(" – " + (ev.descripcion || "")));

          if (ev.tipo) {
            const spanTipo = document.createElement("span");
            spanTipo.className = "tipo";
            spanTipo.textContent = " · " + ev.tipo;
            li.appendChild(spanTipo);
          }

          if (ev.etapas && opciones.mostrarEtapas) {
            const spanEtapas = document.createElement("span");
            spanEtapas.className = "etapas";
            spanEtapas.textContent = " [" + ev.etapas + "]";
            li.appendChild(spanEtapas);
          }

          ul.appendChild(li);
        });

        section.appendChild(ul);
        frag.appendChild(section);
      });

      container.appendChild(frag);
    }

    function renderFestivosLocales(containerId, municipioSeleccionado) {
      const cont = document.getElementById(containerId);
      cont.innerHTML = "";

      if (!municipioSeleccionado) {
        cont.innerHTML = "<p class='nota'>Si quieres ver festivos locales, selecciona un municipio.</p>";
        return;
      }

      const fila = festivosLocales.find(
        f => (f.municipio || "").toLowerCase() === municipioSeleccionado.toLowerCase()
      );

      if (!fila) {
        cont.innerHTML = "<p class='nota'>No se han registrado festivos locales para este municipio.</p>";
        return;
      }

      const h3 = document.createElement("h3");
      h3.textContent = "Festivos locales en " + fila.municipio + " (" + (fila.provincia || "Extremadura") + ")";

      const ul = document.createElement("ul");

      const f1 = (fila.festivo1_fecha || "").trim();
      const n1 = (fila.festivo1_nombre || "").trim() || "Festivo local";
      const f2 = (fila.festivo2_fecha || "").trim();
      const n2 = (fila.festivo2_nombre || "").trim() || "Festivo local";

      if (f1 || n1) {
        const li1 = document.createElement("li");
        li1.textContent = (f1 ? f1 : "") + (f1 && n1 ? " – " : "") + n1;
        ul.appendChild(li1);
      }

      if (f2 || n2) {
        const li2 = document.createElement("li");
        li2.textContent = (f2 ? f2 : "") + (f2 && n2 ? " – " : "") + n2;
        ul.appendChild(li2);
      }

      cont.appendChild(h3);
      cont.appendChild(ul);
    }

    function initTabs() {
      const tabButtons = document.querySelectorAll(".tab-btn");
      const tabContents = {
        escolar: document.getElementById("tab-escolar"),
        laboral: document.getElementById("tab-laboral")
      };

      tabButtons.forEach(btn => {
        btn.addEventListener("click", () => {
          const tab = btn.dataset.tab;
          tabButtons.forEach(b => b.classList.remove("active"));
          btn.classList.add("active");
          Object.keys(tabContents).forEach(key => {
            tabContents[key].classList.toggle("active", key === tab);
          });
        });
      });
    }

    function poblarSelectCurso() {
      const selectCurso = document.getElementById("select-curso");
      const cursos = Array.from(new Set(
        escolarData.map(r => (r.curso || "").trim()).filter(Boolean)
      )).sort();

      selectCurso.innerHTML = '<option value="">Selecciona curso…</option>';
      cursos.forEach(curso => {
        const opt = document.createElement("option");
        opt.value = curso;
        opt.textContent = curso;
        selectCurso.appendChild(opt);
      });
    }

    function poblarSelectAnio() {
      const selectAnio = document.getElementById("select-anio");
      const anios = Array.from(new Set(
        laboralData.map(r => (r.anio || "").trim()).filter(Boolean)
      )).sort((a, b) => Number(a) - Number(b));

      selectAnio.innerHTML = '<option value="">Selecciona año…</option>';
      anios.forEach(anio => {
        const opt = document.createElement("option");
        opt.value = anio;
        opt.textContent = "Año " + anio;
        selectAnio.appendChild(opt);
      });
    }

    function poblarMunicipiosConPlaceholder() {
      const selectEsc = document.getElementById("select-municipio-escolar");
      const selectLab = document.getElementById("select-municipio-laboral");

      const municipios = Array.from(new Set(
        festivosLocales.map(r => (r.municipio || "").trim()).filter(Boolean)
      )).sort((a, b) => a.localeCompare(b, "es"));

      selectEsc.innerHTML = "";
      selectLab.innerHTML = "";

      const ph1 = document.createElement("option");
      ph1.value = "";
      ph1.textContent = "Selecciona un municipio…";
      selectEsc.appendChild(ph1);

      const ph2 = document.createElement("option");
      ph2.value = "";
      ph2.textContent = "Selecciona un municipio…";
      selectLab.appendChild(ph2);

      municipios.forEach(m => {
        const opt1 = document.createElement("option");
        opt1.value = m;
        opt1.textContent = m;
        selectEsc.appendChild(opt1);

        const opt2 = document.createElement("option");
        opt2.value = m;
        opt2.textContent = m;
        selectLab.appendChild(opt2);
      });

      selectEsc.value = "";
      selectLab.value = "";
    }

    function renderEscolar() {
      const selectCurso = document.getElementById("select-curso");
      const selectMuni = document.getElementById("select-municipio-escolar");
      const chkCeleb = document.getElementById("chk-celebraciones");
      const contLista = document.getElementById("escolar-lista");

      const cursoSel = (selectCurso.value || "").trim();
      const muniSel = (selectMuni.value || "").trim();
      const mostrarCelebraciones = chkCeleb.checked;

      if (!cursoSel) {
        contLista.innerHTML = "<p class='nota'>Selecciona un curso académico para ver el calendario escolar.</p>";
        renderFestivosLocales("escolar-festivos-locales", muniSel);
        return;
      }

      let eventos = escolarData.filter(r => (r.curso || "").trim() === cursoSel);

      if (!mostrarCelebraciones) {
        eventos = eventos.filter(r => {
          const t = (r.tipo || "").toLowerCase();
          return !(t === "celebracion" || t === "celebración");
        });
      }

      const porMes = agruparPorMes(eventos, "fecha", { tipo: "escolar", curso: cursoSel });
      const ordenAcademico = [8,9,10,11,0,1,2,3,4,5,6,7];

      renderListaPorMes(contLista, porMes, { mostrarEtapas: true, ordenMeses: ordenAcademico });
      renderFestivosLocales("escolar-festivos-locales", muniSel);
    }

    function renderLaboral() {
      const selectAnio = document.getElementById("select-anio");
      const selectMuni = document.getElementById("select-municipio-laboral");
      const contLista = document.getElementById("laboral-lista");

      const anioSel = (selectAnio.value || "").trim();
      const muniSel = (selectMuni.value || "").trim();

      if (!anioSel) {
        contLista.innerHTML = "<p class='nota'>Selecciona un año para ver el calendario laboral.</p>";
        renderFestivosLocales("laboral-festivos-locales", muniSel);
        return;
      }

      const eventos = laboralData.filter(r => (r.anio || "").trim() === anioSel);
      const porMes = agruparPorMes(eventos, "fecha", { tipo: "laboral", anio: anioSel });

      renderListaPorMes(contLista, porMes, { mostrarEtapas: false });
      renderFestivosLocales("laboral-festivos-locales", muniSel);
    }

    async function cargarDatos() {
      const escolarLista = document.getElementById("escolar-lista");
      const laboralLista = document.getElementById("laboral-lista");

      try {
        const [txtEsc, txtLab, txtLoc] = await Promise.all([
          fetch("/calendario_escolar.csv?v=" + Date.now()).then(r => r.ok ? r.text() : ""),
          fetch("/calendario_laboral.csv?v=" + Date.now()).then(r => r.ok ? r.text() : ""),
          fetch("/festivos_locales.csv?v=" + Date.now()).then(r => r.ok ? r.text() : "")
        ]);

        if (txtEsc) {
          escolarData = parseCSVSimple(txtEsc);
        } else {
          escolarLista.innerHTML = "<p class='nota'>No se ha encontrado el archivo calendario_escolar.csv.</p>";
        }

        if (txtLab) {
          laboralData = parseCSVSimple(txtLab);
        } else {
          laboralLista.innerHTML = "<p class='nota'>No se ha encontrado el archivo calendario_laboral.csv.</p>";
        }

        if (txtLoc) {
          festivosLocales = parseCSVSimple(txtLoc);
        }

        poblarSelectCurso();
        poblarSelectAnio();
        poblarMunicipiosConPlaceholder();

        renderEscolar();
        renderLaboral();
      } catch (e) {
        console.error(e);
        escolarLista.innerHTML = "<p class='nota'>Se ha producido un error al cargar los datos del calendario.</p>";
        laboralLista.innerHTML = "<p class='nota'>Se ha producido un error al cargar los datos del calendario.</p>";
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      initTabs();
      cargarDatos();

      document.getElementById("select-curso").addEventListener("change", renderEscolar);
      document.getElementById("select-municipio-escolar").addEventListener("change", renderEscolar);
      document.getElementById("chk-celebraciones").addEventListener("change", renderEscolar);

      document.getElementById("select-anio").addEventListener("change", renderLaboral);
      document.getElementById("select-municipio-laboral").addEventListener("change", renderLaboral);

      document.getElementById("btn-limpiar-escolar").addEventListener("click", () => {
        document.getElementById("select-municipio-escolar").value = "";
        renderEscolar();
      });

      document.getElementById("btn-limpiar-laboral").addEventListener("click", () => {
        document.getElementById("select-municipio-laboral").value = "";
        renderLaboral();
      });
    });
  </script>
</body>
</html>

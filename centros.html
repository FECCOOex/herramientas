<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Centros de trabajo · Herramientas FECCCOOEx</title>

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />

  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f7f7f7;
      color: #222;
    }

    /* HEADER */
    header {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 14px 24px;
      background: #d60000;
      color: #fff;
      box-shadow: 0 2px 4px rgba(0,0,0,0.25);
    }
    header img {
      height: 52px;
    }
    header .titles h1 {
      margin: 0;
      font-size: 1.5rem;
      font-weight: 700;
    }
    header .titles p {
      margin: 2px 0 0;
      font-size: 0.9rem;
      opacity: 0.9;
    }

    main {
      max-width: 1200px;
      margin: 24px auto 40px;
      padding: 0 16px;
    }

    .layout {
      display: grid;
      grid-template-columns: 320px 1fr;
      gap: 16px;
      margin-bottom: 18px;
    }

    @media (max-width: 900px) {
      .layout {
        grid-template-columns: 1fr;
      }
    }

    .block {
      background: #fff;
      border-radius: 8px;
      padding: 16px 18px;
      margin-bottom: 18px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.06);
      transition: transform 0.15s ease, box-shadow 0.15s ease;
    }
    .block:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 10px rgba(0,0,0,0.12);
    }

    .block h2 {
      margin: 0 0 8px;
      font-size: 1.2rem;
      color: #d60000;
    }
    .block p {
      margin: 0 0 8px;
      font-size: 0.9rem;
      color: #444;
    }

    /* Botones generales */
    .btn-primary {
      background: #d60000;
      color: #fff;
      margin-top: 10px;
      padding: 6px 10px;
      font-size: 0.85rem;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      font-weight: 600;
    }
    .btn-secondary {
      background: #f0f0f0;
      color: #333;
      margin-left: 6px;
      margin-top: 10px;
      padding: 6px 10px;
      font-size: 0.85rem;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      font-weight: 600;
    }

    /* Botón volver a la portada */
    .btn-volver {
      display: inline-block;
      padding: 6px 12px;
      font-size: 0.9rem;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      font-weight: 600;
      background: #d60000;
      color: #fff;
      text-decoration: none;
      margin-top: 6px;
    }
    .btn-volver:hover {
      background: #b40000;
    }

    .small-note {
      font-size: 0.75rem;
      color: #666;
      margin-top: 8px;
    }

    /* Mapa */
    #map {
      width: 100%;
      height: 520px;
      border-radius: 8px;
    }

    /* Resultados tabla */
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
    }
    thead {
      background: #f0f0f0;
    }
    th, td {
      padding: 6px 8px;
      border-bottom: 1px solid #e0e0e0;
      text-align: left;
    }
    tbody tr:hover {
      background: #fafafa;
    }

    .distance-box {
      margin-top: 10px;
      padding: 6px 8px;
      border-radius: 4px;
      background: #ffe5e5;
      color: #6b0000;
      font-size: 0.8rem;
    }

    .error-msg {
      margin-top: 8px;
      padding: 8px;
      font-size: 0.8rem;
      border-radius: 4px;
      background: #ffe5e5;
      color: #6b0000;
    }

    footer {
      font-size: 0.75rem;
      text-align: center;
      padding: 12px;
      color: #444;
      border-top: 1px solid #e0e0e0;
      background: #fafafa;
    }
    footer img {
      height: 22px;
      vertical-align: middle;
      margin-right: 6px;
    }
  </style>
</head>
<body>

  <header>
    <img src="img/feccooex.png" alt="FECCOOEx">
    <div class="titles">
      <h1>Centros de trabajo</h1>
      <p>Localización y filtrado de centros educativos de Extremadura</p>
    </div>
  </header>

  <main>
    <section class="block" id="intro-block">
      <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:12px; flex-wrap:wrap;">
        <div>
          <h2>Descripción de la herramienta</h2>
          <p>
            Este apartado permite visualizar en un mapa los centros educativos incluidos en la base de datos, filtrarlos
            por municipio, zona, tipo de centro y horario, y consultar la distancia aproximada entre dos centros.
          </p>
          <p class="small-note">
            La información procede de un fichero <code>centros.csv</code> que se actualiza internamente. Asegúrate de que
            el archivo está en la misma carpeta que este HTML y que la fila de cabecera es:
          </p>
          <p class="small-note">
            <code>
              id, nombre, codigo_centro, titularidad, tipo_centro, etapas, lat, lng, zona, direccion, cp, municipio,
              provincia, telefono, fax, email, web, horario, jornada_partida, notas
            </code>
          </p>
        </div>
        <div style="text-align:right;">
          <button class="btn-volver" onclick="window.location.href='index.html'">
            Volver a la portada
          </button>
        </div>
      </div>
      <div id="csv-error" class="error-msg" style="display:none;"></div>
    </section>

    <section class="layout">
      <!-- Panel de filtros -->
      <aside class="block filters">
        <h2>Filtros</h2>
        <p style="font-size:0.85rem;">
          Selecciona uno o varios criterios y se actualizarán el mapa y el listado inferior.
        </p>

        <label for="f-municipio">Municipio</label>
        <select id="f-municipio">
          <option value="">Todos</option>
        </select>

        <label for="f-zona">Zona</label>
        <select id="f-zona">
          <option value="">Todas</option>
        </select>

        <label for="f-tipo">Tipo de centro</label>
        <select id="f-tipo">
          <option value="">Todos</option>
        </select>

        <label for="f-horario">Horario</label>
        <select id="f-horario">
          <option value="">Todos</option>
        </select>

        <div style="margin-top:10px;">
          <button class="btn-primary" id="btn-aplicar">Aplicar filtros</button>
          <button class="btn-secondary" id="btn-reset">Limpiar</button>
        </div>

        <hr style="margin:14px 0; border:none; border-top:1px solid #eee;">

        <h2 style="font-size:1rem; margin-bottom:4px;">Medir distancia</h2>
        <p style="font-size:0.8rem;">
          Activa el modo de medida y haz clic sucesivamente en dos centros del mapa para obtener la distancia
          aproximada entre ellos.
        </p>
        <button class="btn-secondary" id="btn-medir">Modo medir distancia</button>

        <div class="distance-box" id="distance-box" style="display:none;"></div>
      </aside>

      <!-- Mapa -->
      <section class="block">
        <h2>Mapa de centros</h2>
        <div id="map"></div>
      </section>
    </section>

    <!-- Resultados -->
    <section class="block results">
      <h2>Listado de centros filtrados</h2>
      <p style="font-size:0.85rem;">
        Se muestran los centros que cumplen los criterios seleccionados. El listado se actualiza automáticamente.
      </p>
      <table>
        <thead>
          <tr>
            <th>Nombre</th>
            <th>Municipio</th>
            <th>Zona</th>
            <th>Tipo de centro</th>
            <th>Horario</th>
          </tr>
        </thead>
        <tbody id="results-body">
          <!-- Filas generadas por JavaScript -->
        </tbody>
      </table>
    </section>
  </main>

  <footer>
    <img src="https://licensebuttons.net/l/by-nd/4.0/88x31.png" alt="Licencia CC BY-ND">
    Este contenido se distribuye bajo licencia <strong>Creative Commons BY-ND 4.0</strong>, permitiendo compartir sin modificaciones y con atribución.
  </footer>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    // --- Mapa básico (centro aproximado de Extremadura) ---
    const map = L.map('map').setView([39.2, -6.3], 7);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    const centrosLayer = L.layerGroup().addTo(map);

    let centrosData = [];
    let modoMedir = false;
    let puntoA = null;
    let puntoB = null;

    const selectMunicipio = document.getElementById('f-municipio');
    const selectZona      = document.getElementById('f-zona');
    const selectTipo      = document.getElementById('f-tipo');
    const selectHorario   = document.getElementById('f-horario');
    const tbodyResultados = document.getElementById('results-body');
    const distanceBox     = document.getElementById('distance-box');
    const csvErrorBox     = document.getElementById('csv-error');

    // Parser CSV simple (detecta ; o ,)
    function parseCSV(text) {
      const lines = text.split(/\r?\n/).filter(l => l.trim().length > 0);
      if (lines.length < 2) return { headers: [], rows: [] };

      const headerLine = lines[0];
      const sep = (headerLine.split(';').length > headerLine.split(',').length) ? ';' : ',';

      const headers = headerLine.split(sep).map(h => h.trim());
      const rows = lines.slice(1).map(line => {
        const cols = line.split(sep);
        const obj = {};
        headers.forEach((h, i) => {
          obj[h] = (cols[i] || '').trim();
        });
        return obj;
      });

      return { headers, rows };
    }

    // Carga del CSV de centros
    fetch('centros.csv')
      .then(resp => {
        if (!resp.ok) throw new Error('No se pudo cargar centros.csv (respuesta HTTP no OK)');
        return resp.text();
      })
      .then(text => {
        const parsed = parseCSV(text);
        if (!parsed.headers.length) {
          throw new Error('El archivo centros.csv parece estar vacío o sin cabecera válida.');
        }

        const required = ['id','nombre','codigo_centro','titularidad','tipo_centro','etapas',
                          'lat','lng','zona','direccion','cp','municipio','provincia',
                          'telefono','fax','email','web','horario','jornada_partida','notas'];

        const missing = required.filter(col => !parsed.headers.includes(col));
        if (missing.length) {
          csvErrorBox.style.display = 'block';
          csvErrorBox.textContent =
            'Aviso: faltan columnas esperadas en centros.csv: ' + missing.join(', ');
        }

        // Unificar datos a un formato fijo que usaremos en la app
        centrosData = parsed.rows.map(r => ({
          id:              r['id']              || '',
          nombre:          r['nombre']          || '',
          codigo_centro:   r['codigo_centro']   || '',
          titularidad:     r['titularidad']     || '',
          tipo_centro:     r['tipo_centro']     || '',
          etapas:          r['etapas']          || '',
          lat:             r['lat']             || '',
          lng:             r['lng']             || '',
          zona:            r['zona']            || '',
          direccion:       r['direccion']       || '',
          cp:              r['cp']              || '',
          municipio:       r['municipio']       || '',
          provincia:       r['provincia']       || '',
          telefono:        r['telefono']        || '',
          fax:             r['fax']             || '',
          email:           r['email']           || '',
          web:             r['web']             || '',
          horario:         r['horario']         || '',
          jornada_partida: r['jornada_partida'] || '',
          notas:           r['notas']           || ''
        }));

        inicializarFiltros(centrosData);
        pintarCentros(centrosData);
      })
      .catch(err => {
        console.error(err);
        csvErrorBox.style.display = 'block';
        csvErrorBox.textContent =
          "No se ha podido cargar 'centros.csv'. Revisa que el archivo está en la misma carpeta que este HTML " +
          "y que no esté abierto en exclusiva por otra aplicación.";
        alert("Error al cargar 'centros.csv'. Pulsa F12 y mira la consola para más detalles técnicos.");
      });

    function inicializarFiltros(data) {
      const municipios = new Set();
      const zonas      = new Set();
      const tipos      = new Set();
      const horarios   = new Set();

      data.forEach(c => {
        if (c.municipio) municipios.add(c.municipio);
        if (c.zona)      zonas.add(c.zona);
        if (c.tipo_centro) tipos.add(c.tipo_centro);
        if (c.horario)   horarios.add(c.horario);
      });

      rellenarSelect(selectMunicipio, municipios);
      rellenarSelect(selectZona, zonas);
      rellenarSelect(selectTipo, tipos);
      rellenarSelect(selectHorario, horarios);
    }

    function rellenarSelect(select, valoresSet) {
      const valores = Array.from(valoresSet).sort((a, b) => a.localeCompare(b, 'es'));
      valores.forEach(v => {
        const opt = document.createElement('option');
        opt.value = v;
        opt.textContent = v;
        select.appendChild(opt);
      });
    }

    function aplicarFiltros() {
      const mun = selectMunicipio.value;
      const zon = selectZona.value;
      const tip = selectTipo.value;
      const hor = selectHorario.value;

      const filtrados = centrosData.filter(c => {
        const okMun = !mun || c.municipio === mun;
        const okZon = !zon || c.zona === zon;
        const okTip = !tip || c.tipo_centro === tip;
        const okHor = !hor || c.horario === hor;
        return okMun && okZon && okTip && okHor;
      });

      pintarCentros(filtrados);
    }

    function resetFiltros() {
      selectMunicipio.value = '';
      selectZona.value = '';
      selectTipo.value = '';
      selectHorario.value = '';
      aplicarFiltros();
    }

    function pintarCentros(data) {
      centrosLayer.clearLayers();
      tbodyResultados.innerHTML = '';

      const bounds = [];

      data.forEach(c => {
        const lat = parseFloat((c.lat || '').replace(',', '.'));
        const lng = parseFloat((c.lng || '').replace(',', '.'));

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${c.nombre}</td>
          <td>${c.municipio}</td>
          <td>${c.zona}</td>
          <td>${c.tipo_centro}</td>
          <td>${c.horario}</td>
        `;
        tbodyResultados.appendChild(tr);

        if (!isNaN(lat) && !isNaN(lng)) {
          const marker = L.marker([lat, lng]);

          marker.bindPopup(
            `<strong>${c.nombre}</strong><br>` +
            (c.municipio ? `${c.municipio}<br>` : '') +
            (c.zona ? `Zona: ${c.zona}<br>` : '') +
            (c.tipo_centro ? `Tipo: ${c.tipo_centro}<br>` : '') +
            (c.horario ? `Horario: ${c.horario}<br>` : '') +
            (c.direccion ? `${c.direccion}` : '')
          );

          marker.on('click', () => {
            if (!modoMedir) return;

            if (!puntoA) {
              puntoA = { lat, lng, nombre: c.nombre };
              distanceBox.style.display = 'block';
              distanceBox.textContent = `Primer centro seleccionado: ${c.nombre}. Ahora haz clic en el segundo centro.`;
            } else if (!puntoB) {
              puntoB = { lat, lng, nombre: c.nombre };
              const d = distanciaKm(puntoA.lat, puntoA.lng, puntoB.lat, puntoB.lng);
              distanceBox.style.display = 'block';
              distanceBox.textContent =
                `Distancia aproximada entre "${puntoA.nombre}" y "${puntoB.nombre}": ` +
                `${d.toFixed(1)} km. Pulsa de nuevo en "Modo medir distancia" para reiniciar.`;
            }
          });

          marker.addTo(centrosLayer);
          bounds.push([lat, lng]);
        }
      });

      if (bounds.length > 0) {
        map.fitBounds(bounds, { padding: [20, 20] });
      }
    }

    function distanciaKm(lat1, lon1, lat2, lon2) {
      const R = 6371;
      const toRad = x => x * Math.PI / 180;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a =
        Math.sin(dLat/2) * Math.sin(dLat/2) +
        Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
        Math.sin(dLon/2) * Math.sin(dLon/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    document.getElementById('btn-aplicar').addEventListener('click', aplicarFiltros);
    document.getElementById('btn-reset').addEventListener('click', resetFiltros);

    document.getElementById('btn-medir').addEventListener('click', () => {
      modoMedir = !modoMedir;
      puntoA = null;
      puntoB = null;
      if (modoMedir) {
        distanceBox.style.display = 'block';
        distanceBox.textContent = 'Modo medir activado. Haz clic en el primer centro en el mapa.';
      } else {
        distanceBox.style.display = 'none';
      }
    });
  </script>

</body>
</html>
